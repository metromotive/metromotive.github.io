---
layout: post
title: Inertial Electric Assist
usemathjax: true
---

An electric assist vehicle is one where an electric motor multiplies the effort of a human to propel the vehicle. That is to say it incorporates a controller that seeks to make $F_{motor} = F_{human} /times gain$. 

One of the difficulties in building an electric assist vehicle is measuring the human input in a way that is simple, reliable, and inexpensive. In the example of electric-assist bicycles, sensors typically measure pedal torque or chain tension, either directly or indirectly. These sensors can be complicated--often requiring a rotating electrical signal to be connected to a non-rotating control system—and require careful calibration. 

An alternative is to instead measure the acceleration of the vehicle using an inexpensive inertial measurement unit (IMU) circuit, and then measure, estimate, or be told the (gross) mass of the vehicle. Via Newton’s second law, we can arrive at the sum total of all of the forces acting on the vehicle. We then have to subtract all of the non-human forces applied to the vehicle to arrive at the human contribution to the propulsion force. 

The forces acting on a typical vehicle will be gravity ($F_g$ = the mass times the acceleration due to gravity, i.e. $g$), an opposing normal force from the ground ($F_N$), force from the propulsion and braking system ($F_p$), resistance from friction ($F_r$, proportional to velocity), and resistance from whatever fluid the vehicle is moving through ($F_d$, proportional to the square of velocity). 

For an electric assist vehicle, if we can measure or estimate the non-propulsion forces on the vehicle, we can calculate the propulsion force, subtract the force produced by the motor, and thereby arrive at the force produced by the human (or requested by the human via their control over the friction brakes).

## Variables to be Measured or Estimated

### Acceleration

The acceleration can be measured using an inexpensive IMU (inertial measurement unit) integrated circuit. These are available at single-digit-dollar prices (or less) and use a MEMS (micro electro-mechanical system) mechanism to measure the acceleration, typically on three orthogonal axes. More expensive units use gyroscopic devices to measure rotation rates, but that information is unnecessary for our application. 

### Mass

The mass of the vehicle is more complicated. Fortunately it is unlikely to change significantly over the course of a trip. One option is to measure the mass using an external system and manually input the mass. Another option is to instruct the user to not apply any human input, and apply a known propulsion force and measure the resulting acceleration (for simplicity at low speed and on flat ground). Or the vehicle can be outfitted with strategically-placed load cells to measure the mass of the rider (along with that of some or all of the vehicle). 

### Motor Force

Modern motor controllers as a matter of course measure and sometimes control the amount of current flowing to the motor. Using the motor current, the torque constant of the motor, and the radius of the wheel (along with any gear reduction), the force provided by the motor can be calculated accurately. 

### Rolling Resistance and Friction

The rolling resistance and friction present in a wheeled vehicle is fairly predictable, usually containing a constant component (present at all but zero speed) along with a component that increases more or less linearly with speed. Speed is another variable that is measured by modern motor controllers as part of their normal operation. 

### Aerodynamic Drag

The aerodynamic drag of a vehicle is harder to predict, as it depends on the drag coefficient (which could vary based on the rider, their clothing, and their position), the local density of air, the wind speed and direction, and the square of vehicle speed relative to the wind. 

Again, speed is straightforward to measure, and the apparent wind in the direction of travel can be measured by a relatively inexpensive anemometer, such as a Pitot tube connected to a differential pressure sensor. The local air density could potentially be measured as well (using a separate pressure absolute pressure sensor connected to the static port), but in practice it likely wouldn’t vary enough to matter. 

The drag coefficient would likely have to be estimated at a fixed value, although it is possible that the vehicle could detect time periods when there is no human force input and calculate an estimate of the aerodynamic drag based on knowledge of the other forces acting on the vehicle. 

### Gravity

On level ground, gravity can be estimated to have zero effect, since it will be exactly cancelled out by the normal force from the ground, however the force of gravity becomes significant when on an incline. 

An accelerometer measuring acceleration strictly along the vehicle’s axis of travel would be unable to distinguish between gravitational force due to an incline and acceleration due to other forces. 

If we incorporate perpendicular axes (particularly one that is vertical relative to the vehicle), it may be possible to subtract one g of acceleration from the total acceleration, since under normal operation the vehicle will not move significantly along any axis other than its axis of travel, and thereby estimate the acceleration due to non-gravitational forces. 

Another option is to measure the odometric acceleration along the axis of travel by measuring the rate of change of speed from the motor controller. 

### Human Inputs

What’s left are human-initiated force inputs. On an electric-assist vehicle, this will be something like pedaling or pushing along with braking using friction brakes. 

Again, a number of systems exist to more directly measure human inputs, but it is also potentially feasible to calculate an estimate of human inputs by measuring acceleration and estimating and/or measuring all of the other forces acting on a vehicle along with its mass. 

## The Control Loop

The controller for such as system should have inputs consisting of, at a minimum:

- A measurement of acceleration
- An estimate or measurement of mass
- The current passing through the motor
- A desired gain factor for the amount of motor force to be applied for a given human force application

This is sufficient to determine (at low speeds and on level ground) whether the motor current should be increased or decreased to keep the motor force equal to the human-input force multiplied by the desired gain. 

The control loop can be enhanced with:

- An estimate of rolling friction (based on the motor speed)
- An estimate of aerodynamic drag (based on the apparent wind speed, or the square of the motor speed assuming still air)
- An estimate of the gravitational force along the axis of travel

On major enhancement would be the ability to detecting when the human force inputs are likely zero. For an electric-assist bicycle, the variation in torque due to the instantaneous pedal position could be detected when present, and thus when absent. Braking forces may be harder to detect since they don’t vary on a regular periodic basis, and thus it could be difficult to discriminate between an unknown braking force and an error in estimating one or more other variables. On the other hand, brake controls can be fitted with switches to detect when they are not being applied. 

When the human force inputs are determined to be zero, the control system could detect which parameters are varying based on the speed versus the square of speed versus the (odometric and/or inertial) acceleration. This should allow estimates of friction, drag, and mass to be refined over time. 

## Vehicle Applications

The vehicle types this could be applied to are many:

- Pedal-assist (“Pedelec”) ebikes
- Scooters
- Skateboards (although braking would have to be considered)
- Wheelchairs
- Bike trailers
- Dollies
- Handtrucks
- Wheelbarrows

## Prior Art

- A similar principle is used in trailer brake controllers. When the towing vehicle applies its brakes, an accelerometer is used to measure the braking rate, and a proportional signal is used to apply the brakes of the trailer. 
- An accelerometer-based system for a pedal assist ebike is described here. 
